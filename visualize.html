<!DOCTYPE html>
<html>
    <head>
	<meta charset=utf-8>
	<title>Turbo Carnival</title>
	<style>
	 body { margin: 0; }
	 canvas { width: 100%; height: 100% }
	</style>
    </head>
    <body>
	<script src="js/three.js"></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script>

	 d3.csv("sample_data/demo.small", function(error, data){
	     draw(data);
	 });

	 var frame = 0;
	 var max_frame = 0;
	 var objects = {};
	 var geometries = {};

	 var scene = new THREE.Scene();
	 var camera = new THREE.PerspectiveCamera( 50, window.innerWidth / window.innerHeight, 1, 6000 );	 
	 var renderer = new THREE.WebGLRenderer();

	 var point_light = new THREE.PointLight( 0xffffff, 1, 9000 );
	 point_light.position.set( 0, 0, 1000 );
	 scene.add( point_light );

	 var ambient_light = new THREE.AmbientLight ( 0x404040 );
	 scene.add( ambient_light );

	 var plane = new THREE.Mesh(new THREE.PlaneGeometry(4030*2, 5113*2),
				    new THREE.MeshLambertMaterial( { color: 0x00ff00 }));
	 scene.add( plane );

	 var arena = new THREE.Mesh(new THREE.BoxGeometry(4030*2, 5113*2, 2000),
				    new THREE.MeshLambertMaterial( { color: 0xaaaaaa, side: THREE.BackSide }));
	 scene.add( arena );
	 
	 var goal1 = new THREE.Mesh(new THREE.BoxGeometry(1633, 1400, 200),
				    new THREE.MeshLambertMaterial( { color: 0xffffff, wireframe: true } ));
	 goal1.position.set(0, 5113+500, 100);
	 scene.add(goal1);
	 
	 var goal2 = new THREE.Mesh(new THREE.BoxGeometry(1633, 1400, 200),
				    new THREE.MeshLambertMaterial( { color: 0xffffff, wireframe: true } ));
	 goal2.position.set(0, -(5113+500), 100);
	 scene.add(goal2);
	 
	 var text_overlay = document.createElement('div');
	 text_overlay.style.position = 'absolute';
	 text_overlay.style.color = 'white';

	 var frame_counter = document.createElement('h1');
	 frame_counter.innerHTML = "Frame: ";
	 text_overlay.appendChild(frame_counter);
	 
	 document.body.appendChild(text_overlay);
	 
	 var frame_data;

	 var frame_by_frame_mode = false;
	 
	 document.onkeydown = checkKey;
	 function checkKey(e) {
	     if (e.keyCode === 37) {
		 // left arrow
		 frame_by_frame_mode = true;
		 if (frame > 0) {
		     frame--;
		 }
	     }
	     else if (e.keyCode === 39) {
		 // right arrow
		 frame_by_frame_mode = true;
		 if (frame < max_frame) {
		     frame++;
		 }
	     }
	     else if (e.keyCode === 32) {
		 // space 
		 frame_by_frame_mode = false;		 
	     }
	 }
	 
	 function draw(data) {
	     frame_data = data;

	     max_frame = d3.max(data, function(d) { return parseInt(d.frame) });
	     
	     renderer.setSize( window.innerWidth - 5, window.innerHeight - 5);
	     document.body.appendChild( renderer.domElement );

  	     for(item in data) {
		 if (data[item].frame != 0) {
		     break;
		 }
		 var line = data[item];
		 objects[line.id] = data[item];
	     }
	     for(actor in objects) {

		 if (actor == 'ball') {
		     var sphere = new THREE.Mesh(new THREE.SphereGeometry( 100, 32, 32 ),
						 new THREE.MeshLambertMaterial( { color: 0x0000ff }) );
		     geometries[actor] = sphere; 
		     scene.add( sphere );
		 }
		 else {
		     var geometry = new THREE.BoxGeometry( 200, 100, 50 );
		     var material = new THREE.MeshLambertMaterial( { color: 0xff0000 } );
		     var cube = new THREE.Mesh( geometry, material );
		     geometries[actor] = cube;
		     scene.add( cube );
		 }
	     }	     
	     
	     camera.position.z = 6000;
	     camera.rotateZ(.5*Math.PI);
     
	     render();
	 }
	 
	 function render() {
	     requestAnimationFrame( render );

	     for(item in frame_data) {
		 // Yes I know, super inefficent
		 if (frame_data[item].frame == frame) {
		     datum = frame_data[item];
		     obj = geometries[datum.id];
		     obj.position.set(datum.x, datum.y, datum.z);
		     obj.rotation.set(datum.yaw*Math.PI, datum.roll*Math.PI, datum.pitch*Math.PI);

		     if (datum.id === 'ball') {
			 camera.position.x = datum.x;
			 camera.position.y = datum.y;
		     }
		 }
	     }

	     if (frame_by_frame_mode) {
		 frame_counter.innerHTML = "Frame: " + frame;
	     }
	     else if (frame % 30 === 0) {
		 frame_counter.innerHTML = "Frame: " + frame;
	     }
			     
	     renderer.render( scene, camera );
	     if (!frame_by_frame_mode && frame < max_frame) {
		 frame++;
	     }
	 }
	</script>
    </body>
</html>
